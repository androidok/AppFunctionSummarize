var nextPage=1,loading=!1,isMore=!0,searchMode=!1;$(function(){var a=$("#page").val();"open-source-project"===$("#type").val()&&("open-source-projects"===a?(openSourceProjectsStart(),projectsPageKeyListener(),changeProjectsPageTips(),$(".top-tag-span").click(function(){tagTextClick(this)})):"detail"===a&&($(window).scrollTop(0),0<$("#readme").length&&0==(null==$("#readme").html()||$("#readme").html().length)&&loadReadMe(),changeDetailPageTips(),detailPageKeyListener(),tagListener()))});
function openSourceProjectsStart(){searchMode=1==$("#searchMode").val();var a=$("#projectsString").val(),c;a&&0!=a.length||(a=localStorage.projectArray);a&&(c=jsonParse(a))&&Array.isArray(c)&&(localStorage.projectArray=a,$("#projectsString").val(null));c&&0<c.length?rearrangeProjectsDiv("projects-div","date-project-div","date-div",1,parseIntZero($("#dateCount").val())+1):(clearWaterFlow(),$("#projects-div").show(),$("#projects-div").append(getNoResultHtml()));nextPage=2;$("#div-load-more").click(function(){loadMore()});
$("#search").click(function(){nextPage=1;isMore=!0;changeProjectsShortcutCount(2);searchProject()});$("#searchProjectForm").on("submit",function(a){nextPage=1;isMore=!0;changeProjectsShortcutCount(2);searchProject();return!1});$(window).scroll(function(){$(this).scrollTop()+$(window).height()+20>=$(document).height()&&20<$(this).scrollTop()&&$("#div-load-more").length&&loadMore()})}function loadMore(){searchMode?searchProject():loadMoreProjects()}
function loadMoreProjects(){loading||(isMore?(divLoading(),$.ajax($("#host").val()+"/api/op/page/"+nextPage+"?type=mix").done(function(a){try{var c=jsonParse(a),b,d;null!=c&&0===c.code&&null!=(b=c.data)&&null!=(d=b.projectDateMap)?(setLocalStorageProjectArray(c.data.projectArray),addProjectsDiv(d)):divLoadError()}catch(e){divLoadError()}}).fail(function(){divLoadError()}).always(function(){loading=!1})):divLoaded(!1))}
function addProjectsDiv(a){if(0==Object.keys(a).length)divLoaded(!1);else{var c,b="",d=$("#lastDate").val(),e=parseIntZero($("#dateCount").val());c=e;for(dateKey in a){d!==dateKey&&(0<b.length&&$("#projects-div").append(b),e++,b+='<div id="date-project-div'+e+'" style="display: none;" class="div-projects">',b+='<div id="date-div'+e+'" class="div-date">'+dateKey+"</div>");var f=a[dateKey];f&&(b+=getProjectsDiv(f));d!==dateKey?(b+='<div id="boder-div'+e+'" style="display: none;" class="div-boder"/>',
b+="</div>"):($("#date-project-div"+e).append(b),b="");d=dateKey}$("#dateCount").val(e);$("#lastDate").val(d);0<b.length&&$("#projects-div").append(b);rearrangeProjectsDiv("projects-div","date-project-div","date-div",c,e+1);divLoaded(!0)}}function getProjectsDiv(a){var c="";a.forEach(function(a){c+='<div class="project-div div-project"><a href="'+a.codeKKUrl+'" target="_blank">'+a.projectName+"</a>";a.desc&&(c+=' <div class="small-image">'+a.desc+"</div>");c+=" </div>"});return c}
function rearrangeProjectsDiv(a,c,b,d,e){a="#"+a;$(a).show();var f=parseIntZero($("#totalColumn").val());for(f&&0!==f||(f=2);d<e;d++){var g="#"+c+d;$(g).is(":visible")||$(g).show();var m=getOuterHeight($("#"+b+d));$(g).children(".project-div");for(var t=getOuterWidth($(g)),h=Array(f),k=0;k<f;k++)h[k]=0;var l=0,n=0,k=0,r;$(g).children(".project-div").each(function(){r||(r=this);$(this).css("left",0+18*l+parseFloatZero(getOuterWidth($(r))*l));$(this).css("padding",8);$(this).outerWidth((t-18*(f-1)-
0)/f-10);k>=f?(h[l]+=18+getOuterHeight($(this)),$(this).css("top",n+18)):(h[l]+=getOuterHeight($(this))+m+parseFloatZero($(g).css("padding-top")),$(this).css("top",parseFloatZero($(g).css("padding-top"))+m));n=h[0];for(var a=l=0;a<h.length;a++)h[a]<n&&(n=h[a],l=a);k++});for(var p=0,k=0;k<h.length;k++)h[k]>p&&(p=h[k]);var q="#boder-div"+d;$(q).is(":visible")||$(q).show();$(q).css("top",p);$(g).outerHeight(p+parseFloatZero($(g).css("padding-top"))+parseFloatZero($(g).css("padding-bottom"))+getOuterHeight($(q)))}b=
0;for(d=1;d<e;d++)b+=getOuterHeight($("#"+c+d));$(a).outerHeight(b+getOuterHeight($("#searchProjectForm")))}function divLoading(){loading=!0;$("#div-load-more").html("\u52a0\u8f7d\u4e2d\u2026");$("#div-load-more").show()}function divLoaded(a){a?(++nextPage,$("#div-load-more").html("\u70b9\u51fb\u52a0\u8f7d\u66f4\u591a"),$("#div-load-more").show()):($("#div-load-more").html("\u5df2\u7ecf\u52a0\u8f7d\u5b8c\u4e86\u54e6"),$("#div-load-more").fadeOut());loading=!1;isMore=a}
function divLoadError(){$("#div-load-more").html("\u70b9\u51fb\u52a0\u8f7d\u66f4\u591a");$("#div-load-more").show();loading=!1}function searchProject(){if(!loading)if(isMore){loading=!0;var a=$("#searchText").val();a&&256<(a=a.trim()).length&&(a=a.substring(0,256));searchMode=0<a.length;$("#search").attr("disabled","true");a=$("#host").val()+"/api/op/search?text="+(a?a:"")+"&page="+nextPage;$.get(a,function(a,b){$("#search").removeAttr("disabled");searchBack(a)})}else divLoaded(!1)}
function searchBack(a){1==nextPage&&clearWaterFlow();try{var c=jsonParse(a);if(null!=c&&0===c.code){if(c.data.isFullSearch)isMore=!0,setLocalStorageProjectArray(c.data.projectArray),addProjectsDiv(c.data.projectArray);else{setLocalStorageProjectArray(c.data.projectArray);showSearchWaterFlow(c.data);$("#dateCount").val(1);$("#searchMode").val(1);return}return!0}localStorage.removeItem("projectArray");showSearchError(c);return!1}catch(b){return localStorage.removeItem("projectArray"),showSearchError(c),
!1}}function clearWaterFlow(){divLoaded(!1);$("#dateCount").val(0);$("#lastDate").val(0);$("div[id^='date-project-div']").each(function(a,c){this.remove()})}
function showSearchWaterFlow(a){var c=a.projectArray;if(c&&0<c.length){var b="";2>nextPage&&(b="",a.totalCount>c.length&&(b="\uff08"+Math.ceil(a.totalCount/a.pageSize)+" \u9875\uff09"),b='<div id="date-project-div1" style="display: none;" class="div-projects">'+('<div id="date-div1" class="div-date">\u5171 '+a.totalCount+" \u4e2a\u9879\u76ee"+b+"</div>"));b+=getProjectsDiv(c);2>nextPage&&(b+=" </div>");2>nextPage?$("#projects-div").append(b):$("#date-project-div1").append(b);rearrangeProjectsDiv("projects-div",
"date-project-div","date-div",1,2);divLoaded(c&&c.length>=a.pageSize)}else 2>nextPage&&$("#projects-div").append(getNoResultHtml()),divLoaded(c&&c.length>=a.pageSize),$("#projects-div").css("height","auto")}function getNoResultHtml(){var a;return a='<div id="date-project-div1" class="div-projects"><div id="date-div1" class="div-date">\u65e0\u7b26\u5408\u6761\u4ef6\u7684\u9879\u76ee</div> </div>'}var tagSpanPrefix="tagSpan",tagTextPrefix="tagText",tagDeletePrefix="tagDelete";
function tagTextClick(a){var c;if(null!=$(a).html()&&0<(c=$(a).html().trim()).length){if(20<c.length)return showErrorMsg("\u6807\u7b7e\u4e0d\u80fd\u4e3a\u7a7a\u4e14\u957f\u5ea6\u4e0d\u80fd\u5927\u4e8e 20"),!1;a=$("#host").val()+"?s="+encodeURIComponent(c);window.location=a;return!1}}
function tagDelteClick(a){a=$(a).attr("id");var c=a.indexOf(tagDeletePrefix);if(0<=c){a=a.substring(c+tagDeletePrefix.length);var c="#tagText"+a,b="#"+tagSpanPrefix+a,d;if(null!=$(c).html()&&0<(d=$(c).html().trim()).length){if(20<d.length)return showErrorMsg("\u6807\u7b7e\u4e0d\u80fd\u4e3a\u7a7a\u4e14\u957f\u5ea6\u4e0d\u80fd\u5927\u4e8e 20"),!1;$(b).removeClass("red-border").removeClass("green-border").addClass("gray-border");a=$("#host").val()+"/api/op/untagging";$.post(a,{tagName:d,projectId:$("#projectId").val()},
function(a){a=taggingBack(a);null==a||0!=a.code?($(b).removeClass("gray-border").addClass("red-border"),$(b).attr("title",a?a.message:"\u5220\u9664\u51fa\u9519"),62==a.code&&$(b).delay(600).fadeOut(300)):$(b).fadeOut(300)}).fail(function(){$(b).removeClass("gray-border").addClass("red-border");$(b).attr("title","\u5220\u9664\u51fa\u9519\uff0c\u65e0\u6cd5\u8fde\u63a5\u670d\u52a1\u5668\u6216\u670d\u52a1\u5668\u5185\u90e8\u51fa\u9519");showErrorMsg("\u65e0\u6cd5\u8fde\u63a5\u670d\u52a1\u5668\u6216\u670d\u52a1\u5668\u5185\u90e8\u51fa\u9519")});
return!1}}}function tagSpanMouseEnter(a){a=$(a).attr("id");var c=a.indexOf(tagSpanPrefix);0<=c&&(a=a.substring(c+tagSpanPrefix.length),$("#tagDelete"+a).removeClass("color-transparent").addClass("color-light-red"))}function tagSpanMouseLeave(a){a=$(a).attr("id");var c=a.indexOf(tagSpanPrefix);0<=c&&(a=a.substring(c+tagSpanPrefix.length),$("#tagDelete"+a).removeClass("color-light-red").addClass("color-transparent"))}
function tagDeleteMouseEnter(a){$(a).removeClass("color-light-red").addClass("color-red").addClass("font-bold")}function tagDeleteMouseLeave(a){$(a).removeClass("color-red").removeClass("font-bold").addClass("color-light-red")}
function getTagHtml(a,c){return'<span id="tagSpan'+a+'" class="gray-border tag-span float-left"><span id="tagText'+a+'" class="tag-text no-background no-border">'+c+'</span><span id="tagDelete'+a+'" title="\u5220\u9664\u6807\u7b7e" class="tag-delete color-transparent">-</span></span>'}
function tagListener(){$(".tag-delete").click(function(){tagDelteClick(this)});$(".tag-delete").mouseenter(function(){tagDeleteMouseEnter(this)});$(".tag-delete").mouseleave(function(){tagDeleteMouseLeave(this)});$(".tag-text").click(function(){tagTextClick(this)});$(".tag-span").mouseenter(function(){tagSpanMouseEnter(this)});$(".tag-span").mouseleave(function(){tagSpanMouseLeave(this)});document.getElementById("newTag").onkeypress=function(a){var c;if(-1!==[13,44,65292,65307,12289].indexOf(a.keyCode?
a.keyCode:a.which)&&null!=$("#newTag").val()&&0<(c=$("#newTag").val().trim()).length){changeOPDetailShortcutCount(4,!0);if(20<c.length)return showErrorMsg("\u6807\u7b7e\u4e0d\u80fd\u4e3a\u7a7a\u4e14\u957f\u5ea6\u4e0d\u80fd\u5927\u4e8e 20"),!1;var b=parseIntZero($("#tagCount").val())+1,d="#"+tagSpanPrefix+b,e="#"+tagTextPrefix+b,f="#"+tagDeletePrefix+b;$("#tagCount").val(b);a=getTagHtml(b,c);$(a).insertBefore("#newTag");$("#newTag").val("");a=$("#host").val()+"/api/op/tagging";$.post(a,{tagName:c,
projectId:$("#projectId").val()},function(a){a=taggingBack(a);null==a||0!=a.code?($(d).removeClass("gray-border").addClass("red-border"),$(d).attr("title",a?a.message:"\u6dfb\u52a0\u51fa\u9519"),54==a.code&&$(d).delay(600).fadeOut(300)):($(d).removeClass("gray-border").addClass("green-border"),$("#tagDelete"+b).click(function(){tagDelteClick(this)}),$(e).click(function(){tagTextClick(this)}),$(d).mouseenter(function(){tagSpanMouseEnter(this)}),$(d).mouseleave(function(){tagSpanMouseLeave(this)}),
$(f).mouseenter(function(){tagDeleteMouseEnter(this)}),$(f).mouseleave(function(){tagDeleteMouseLeave(this)}))}).fail(function(){$(d).removeClass("gray-border").addClass("red-border");$(d).attr("title","\u6dfb\u52a0\u51fa\u9519\uff0c\u65e0\u6cd5\u8fde\u63a5\u670d\u52a1\u5668\u6216\u670d\u52a1\u5668\u5185\u90e8\u51fa\u9519");showErrorMsg("\u65e0\u6cd5\u8fde\u63a5\u670d\u52a1\u5668\u6216\u670d\u52a1\u5668\u5185\u90e8\u51fa\u9519")});return!1}}}
function taggingBack(a){try{var c=jsonParse(a);if(null!=c){if(0==c.code)return showSuccessMsg(c.message),c;isUserNotLogin(c.code);showErrorMsg(c.message)}return c}catch(b){return showErrorMsg("\u670d\u52a1\u5668\u8fd4\u56de\u7ed3\u679c\u51fa\u9519"),null}}
function setLocalStorageProjectArray(a){if(1==nextPage)localStorage.projectArray=JSON.stringify(a);else if(localStorage.projectArray&&Array.isArray(a)){var c=jsonParse(localStorage.projectArray);c&&Array.isArray(c)&&(localStorage.projectArray=JSON.stringify(c.concat(a)))}else localStorage.projectArray=JSON.stringify(a)}function getOuterWidth(a){return a&&0<a.length?a[0].getBoundingClientRect().width:0}function getOuterHeight(a){return a&&0<a.length?a[0].getBoundingClientRect().height:0}
function showSearchError(a){a='<div id="date-project-div1" class="div-projects">'+('<div id="date-div1" class="div-date">'+(a&&a.message?a.message:"\u67e5\u627e\u51fa\u9519")+'\uff0c\u6b22\u8fce\u5fae\u535a\u79c1\u4fe1\u7ed9\u6211\u53cd\u9988\uff0c\u5fae\u535a\uff1a<a href="http://weibo.com/trinea/" target="_blank">Trinea</a></div>');a+=" </div>";$("#projects-div").append(a)}
function loadReadMe(){setViewShow("content-footer",!1);$.get($("#host").val()+"/api/op/detail/"+$("#projectId").val()+"/readme",function(a){a=jsonParse(a);var c;null!=a&&0===a.code&&null!=(c=a.data)&&c.id==$("#projectId").val()&&c.content&&0<c.content.length?$("#readme").html(c.content):$("#readme").html('\u52a0\u8f7d\u5931\u8d25\uff0c\u53ef\u8054\u7cfb <a href="http://www.weibo.com/trinea" target="_blank">Trinea</a>');$("#readme").show();$("#loading").hide();setViewShow("content-footer",!0);refreshIsEdge()})}
function loadRelatedPost(){var a=$("#detailId").val();a&&$.get($("#apiHost").val()+"/doc/similar?type="+$("#type").val()+"&id="+a+"&size=3&time="+(new Date).getTime(),function(a){a=jsonParse(a);var b;null!=a&&0===a.code&&null!=(b=a.data)&&b.docs?0<b.docs.length&&($("#div-related-post").html(getRelatedPostsHtml(b.docs)),setViewShow("div-related-post",!0)):($("#div-related-post").html('\u76f8\u5173\u63a8\u8350\u52a0\u8f7d\u5931\u8d25\uff0c\u53ef\u8054\u7cfb <a href="http://www.weibo.com/trinea" target="_blank">Trinea</a>'),
setViewShow("div-related-post",!0))})}function getRelatedPostsHtml(a){if(!a||0>=a.length)return"";var c='<p class="font-bold">\u76f8\u5173\u63a8\u8350\uff1a</p><ul>',b=0;a.forEach(function(a){a&&(b++,c+='<li><a href="'+a.codeKKUrl+'" class="color-normalb underline statistics-class" target="_blank">'+a.title+'</a><input type="hidden" value="related-post/'+b+'" class="statistics-value"></li>')});return c+="</ul>"}
function projectsPageKeyListener(){refreshIsEdge();$(window).scroll(function(){refreshIsEdge()});var a=[37,65,87,76,75],c=[39,68,78,74];window.onkeyup=function(b){b=b.keyCode?b.keyCode:b.which;document.activeElement&&"searchText"===document.activeElement.id&&27==b?(changeProjectsShortcutCount(2),$("#searchText").blur()):document.activeElement&&"BODY"==document.activeElement.tagName&&(-1!==a.indexOf(b)?isLastLegal(b)&&jumpToLastDateProject():-1!==c.indexOf(b)&&isNextLegal(b)&&jumpToNextDateProject(),
83==b&&(changeProjectsShortcutCount(2),document.getElementById("searchText").focus()))}}function isLastLegal(a){return 65<=a&&90>=a||37==a&&isLeftEdge||38==a&&isTopEdge}function isNextLegal(a){return 65<=a&&90>=a||39==a&&isRightEdge||40==a&&isBottomEdge}
function jumpToLastDateProject(){changeProjectsShortcutCount(3);for(var a=$(".div-projects"),c=a.length,b=$(window).scrollTop(),d=getOuterHeight($("#header")),e=!1,c=c-1;0<=c;c--){var f=$(a[c]),g;if(f&&0<(g=d-(f.offset().top-b)-5)){window.scrollBy(0,-1*g);e=!0;break}}e||$(window).scrollTop(0)}
function jumpToNextDateProject(){changeProjectsShortcutCount(3);for(var a=$(".div-projects"),c=a.length,b=$(window).scrollTop(),d=getOuterHeight($("#header")),e=!1,f=0;f<c;f++){var g=$(a[f]),m;if(g&&0<(m=g.offset().top-b-d+5)){window.scrollBy(0,m);e=!0;break}}e||$(window).scrollTop($(document).height())}var isLeftEdge,isRightEdge,isTopEdge,isBottomEdge;
function refreshIsEdge(){isLeftEdge=.1>=$(window).scrollLeft();isRightEdge=$(window).scrollLeft()+$(window).width()>=$(document).width();isTopEdge=.1>=$(window).scrollTop();isBottomEdge=$(window).scrollTop()+$(window).height()>=$(document).height()}
function detailPageKeyListener(){refreshIsEdge();$(window).scroll(function(){refreshIsEdge()});var a=[37,38,65,87,76,75],c=[39,40,68,83,78,74];window.onkeyup=function(b){b=b.keyCode?b.keyCode:b.which;document.activeElement&&"newTag"===document.activeElement.id&&27==b?(changeOPDetailShortcutCount(4,!0),$("#newTag").blur()):document.activeElement&&"BODY"==document.activeElement.tagName&&(-1!==a.indexOf(b)?isLastLegal(b)&&loadLastProject($("#projectId").val(),b):-1!==c.indexOf(b)&&isNextLegal(b)&&loadNextProject($("#projectId").val(),
b),84==b&&(changeOPDetailShortcutCount(3,!0),document.getElementById("newTag").focus()))}}function loadNextProject(a,c){if(1!=$("#isSwitchingProject").val()){$("#isSwitchingProject").val(1);isLoadingNextOrLastProject=!0;var b=localStorage.projectArray;if(b&&(b=jsonParse(b))&&Array.isArray(b)&&0<b.length){var d=-1;b.some(function(b){d++;if(b._id==a)return!0});d++;0<=d&&d<b.length&&(changeOPDetailShortcutCount(2,!1),goToProjectDetail(b[d],"next",c))}}}
function loadLastProject(a,c){if(1!=$("#isSwitchingProject").val()){$("#isSwitchingProject").val(1);var b=localStorage.projectArray;if(b){var b=jsonParse(b),d;if(b&&Array.isArray(b)&&0<(d=b.length)){var e=-1;for(d--;0<=d&&(e=d,b[d]._id!=a);d--);e--;0<=e&&e<b.length&&(changeOPDetailShortcutCount(2,!1),goToProjectDetail(b[e],"last",c))}}}}
function changeOPDetailShortcutCount(a,c){if(!localStorage.opDetailShortcutCount||a>localStorage.opDetailShortcutCount)localStorage.opDetailShortcutCount=a;c&&changeDetailPageTips()}
function changeDetailPageTips(){0>=$("#isMobile").length||"1"==$("#isMobile").val()||localStorage.opDetailShortcutCount&&10<localStorage.opDetailShortcutCount?$("#detailTipDiv").hide():($("#detailTipDiv").removeClass("hidden"),$("#detailTipDiv").show(),!localStorage.opDetailShortcutCount||1>=localStorage.opDetailShortcutCount?$("#detailTipSpan").html("\u5c0f\u6280\u5de7 1\uff1a\u53ef\u901a\u8fc7\u952e\u76d8\u65b9\u5411\u952e\u6216\u5b57\u6bcd\u952e awsd\u3001nl \u5feb\u901f\u67e5\u770b\u524d\u540e\u9879\u76ee\u54e6"):
2==localStorage.opDetailShortcutCount?$("#detailTipSpan").html("\u5c0f\u6280\u5de7 2\uff1a\u53ef\u901a\u8fc7\u5b57\u6bcd\u952e t \u5feb\u901f\u5b9a\u4f4d\u5230\u6807\u7b7e\u6846"):3==localStorage.opDetailShortcutCount?$("#detailTipSpan").html("\u5c0f\u6280\u5de7 3\uff1a\u53ef\u901a\u8fc7\u56de\u8f66\u952e\u3001\u5206\u53f7\u3001\u9017\u53f7\u65b0\u589e\u975e\u7a7a\u6807\u7b7e\uff0cEsc \u952e\u9000\u51fa\u7f16\u8f91"):$("#detailTipDiv").hide())}
function changeProjectsShortcutCount(a){if(!localStorage.projectsShortcutCount||a>localStorage.projectsShortcutCount)localStorage.projectsShortcutCount=a;changeProjectsPageTips()}
function changeProjectsPageTips(){0>=$("#isMobile").length||"1"==$("#isMobile").val()||localStorage.projectsShortcutCount&&10<localStorage.projectsShortcutCount?$("#projectsTipDiv").hide():($("#projectsTipDiv").removeClass("hidden"),$("#projectsTipDiv").show(),!localStorage.projectsShortcutCount||1>=localStorage.projectsShortcutCount?$("#projectsTipSpan").html("\u5c0f\u6280\u5de7 1\uff1a\u53ef\u901a\u8fc7\u5b57\u6bcd\u952e s \u5feb\u901f\u5b9a\u4f4d\u5230\u641c\u7d22\u6846\uff0c\u56de\u8f66\u952e\u5f00\u59cb\u641c\u7d22\uff0cEsc \u952e\u9000\u51fa\u641c\u7d22\u54e6"):
2==localStorage.projectsShortcutCount?$("#projectsTipSpan").html("\u5c0f\u6280\u5de7 2\uff1a\u53ef\u901a\u8fc7\u952e\u76d8\u5de6\u53f3\u65b9\u5411\u952e\u6216\u5b57\u6bcd\u952e ad\u3001nl \u6309\u65e5\u671f\u8fdb\u884c\u5feb\u901f\u7ffb\u9875\u54e6"):$("#projectsTipDiv").hide())}function goToProjectDetail(a,c,b){window.location=$("#host").val()+"/detail/"+a.lang+"/"+a.authorName+"/"+a.projectName+"?from=key&direction="+c+"&key="+b};
